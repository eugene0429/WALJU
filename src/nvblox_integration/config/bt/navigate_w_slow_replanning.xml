<!--
  Behavior Tree: 느린 재계획 + 리커버리 동작 포함
  - 경로 재계획 주기: 0.5 Hz (2초마다)
  - FollowPath 실패 시 리커버리 동작 수행 (ClearCostmap → Wait → 재계획)
  - 최대 6회 리커버리 시도 후 최종 실패
-->

<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <RecoveryNode number_of_retries="6" name="NavigateRecovery">

      <!-- ===== 정상 경로: 계획 + 추종 ===== -->
      <PipelineSequence name="NavigateWithReplanning">
        <ControllerSelector selected_controller="{selected_controller}" default_controller="FollowPath" topic_name="controller_selector"/>
        <PlannerSelector selected_planner="{selected_planner}" default_planner="GridBased" topic_name="planner_selector"/>
        <!-- ★ 재계획 주기: 0.5 Hz = 2초에 한 번 (기존 0.1Hz에서 상향) -->
        <RateController hz="0.1">
          <ComputePathToPose goal="{goal}" path="{path}" planner_id="{selected_planner}" error_code_id="{compute_path_error_code}"/>
        </RateController>
        <FollowPath path="{path}" controller_id="{selected_controller}" error_code_id="{follow_path_error_code}"/>
      </PipelineSequence>

      <!-- ===== 리커버리 시퀀스: 실패 시 순차 실행 ===== -->
      <SequenceWithMemory name="RecoveryActions">
        <!-- 1단계: Costmap 초기화 (일시적 잘못된 장애물 정보 제거) -->
        <ClearEntireCostmap name="ClearLocalCostmap" service_name="local_costmap/clear_entirely_local_costmap"/>
        <ClearEntireCostmap name="ClearGlobalCostmap" service_name="global_costmap/clear_entirely_global_costmap"/>
        <!-- 2단계: 잠시 대기 (costmap이 새 데이터로 갱신될 시간 확보) -->
        <Wait wait_duration="2.0"/>
      </SequenceWithMemory>

    </RecoveryNode>
  </BehaviorTree>
</root>
